<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Subodh_AI</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=Playfair+Display:wght@600&display=swap" rel="stylesheet"/>
<style>
:root {
  --bg: #f7f5f0;
  --sidebar: #eeeae3;
  --surface: #ffffff;
  --border: #ddd8ce;
  --accent: #2d6a4f;
  --accent-h: #245a41;
  --accent-light: #e8f5e9;
  --t1: #1a1a1a;
  --t2: #6b6560;
  --t3: #9b948d;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;height:-webkit-fill-available;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--t1);height:100vh;height:-webkit-fill-available;display:flex;overflow:hidden;}

/* SIDEBAR */
#sidebar{
  width:260px;background:var(--sidebar);border-right:1px solid var(--border);
  display:flex;flex-direction:column;padding:18px 12px;gap:5px;flex-shrink:0;
  transition:transform .3s ease;z-index:100;
}
.logo{font-family:'Playfair Display',serif;font-size:21px;color:var(--accent);padding:6px 8px 14px;border-bottom:1px solid var(--border);margin-bottom:6px;}
.logo span{color:var(--t3);font-family:'DM Sans',sans-serif;font-weight:400;font-size:18px;}
#new-btn{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:11px 14px;font-family:inherit;font-size:14px;font-weight:500;cursor:pointer;display:flex;align-items:center;gap:8px;margin-bottom:4px;transition:background .2s;-webkit-tap-highlight-color:transparent;}
#new-btn:hover{background:var(--accent-h);}
.sec-title{font-size:11px;font-weight:600;color:var(--t3);text-transform:uppercase;letter-spacing:.8px;padding:8px 8px 3px;}
.hist-item{padding:9px 10px;border-radius:9px;font-size:13px;color:var(--t2);cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;transition:background .15s,color .15s;-webkit-tap-highlight-color:transparent;}
.hist-item:hover,.hist-item.active{background:var(--surface);color:var(--t1);}
.sidebar-bottom{margin-top:auto;border-top:1px solid var(--border);padding-top:12px;}
.user-row{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:9px;}
.av{width:32px;height:32px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:13px;flex-shrink:0;}

/* OVERLAY */
#overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:99;}
#overlay.show{display:block;}

/* MAIN */
#main{flex:1;display:flex;flex-direction:column;min-width:0;position:relative;}

/* TOPBAR */
#topbar{background:var(--surface);border-bottom:1px solid var(--border);padding:12px 16px;display:flex;align-items:center;gap:10px;flex-shrink:0;}
#menu-btn{background:none;border:none;cursor:pointer;padding:4px;display:flex;align-items:center;-webkit-tap-highlight-color:transparent;border-radius:8px;}
#menu-btn:active{background:var(--bg);}
.model-badge{background:var(--accent-light);border:1px solid #c8e6c9;border-radius:8px;padding:5px 12px;font-size:13px;font-weight:500;color:var(--accent);}
.status-dot{width:8px;height:8px;border-radius:50%;background:#4caf50;animation:pulse 2s infinite;margin-left:auto;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.4;}}

/* CHAT */
#chat{flex:1;overflow-y:auto;overflow-x:hidden;padding:20px 0;-webkit-overflow-scrolling:touch;}
#chat::-webkit-scrollbar{width:4px;}
#chat::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}

/* WELCOME */
#welcome{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100%;text-align:center;padding:30px 16px;animation:fadeUp .5s ease;}
.w-icon{width:58px;height:58px;border-radius:16px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:26px;margin-bottom:16px;box-shadow:0 8px 24px rgba(45,106,79,.22);}
#welcome h1{font-family:'Playfair Display',serif;font-size:26px;color:var(--t1);margin-bottom:8px;}
#welcome p{color:var(--t2);font-size:14px;max-width:340px;line-height:1.65;margin-bottom:28px;}
.sugg-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;max-width:500px;width:100%;}
.sugg-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 13px;cursor:pointer;text-align:left;font-size:13px;color:var(--t2);line-height:1.5;transition:all .2s;-webkit-tap-highlight-color:transparent;}
.sugg-card:active{border-color:var(--accent);background:var(--accent-light);}
.sugg-card strong{display:block;color:var(--t1);font-size:13px;margin-bottom:2px;}

/* MESSAGES */
.msg-wrap{max-width:720px;margin:0 auto;padding:0 14px 20px;animation:fadeUp .3s ease;}
.msg{display:flex;gap:10px;align-items:flex-start;}
.msg-av{width:28px;height:28px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0;margin-top:2px;}
.msg-av.user{background:var(--accent);color:#fff;}
.msg-av.ai{background:var(--accent-light);color:var(--accent);border:1px solid var(--border);}
.msg-name{font-size:10px;font-weight:600;color:var(--t3);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px;}
.msg-body{flex:1;line-height:1.75;font-size:14px;padding-top:2px;word-break:break-word;}
.msg-body.user-body{background:var(--accent-light);border:1px solid #c8e6c9;border-radius:0 12px 12px 12px;padding:10px 13px;}
.msg-body pre{background:#1e1e2e;color:#cdd6f4;border-radius:10px;padding:12px 14px;overflow-x:auto;margin:10px 0;font-size:12px;line-height:1.6;-webkit-overflow-scrolling:touch;}
.msg-body code{background:#f0ede6;border:1px solid var(--border);border-radius:4px;padding:1px 5px;font-size:12px;font-family:monospace;word-break:break-all;}
.msg-body pre code{background:none;border:none;padding:0;color:inherit;font-size:inherit;word-break:normal;}
.msg-actions{display:flex;gap:5px;margin-top:6px;}
.act-btn{background:none;border:1px solid var(--border);border-radius:6px;padding:4px 10px;font-size:12px;color:var(--t3);cursor:pointer;font-family:inherit;transition:all .15s;-webkit-tap-highlight-color:transparent;}
.act-btn:active{background:var(--bg);color:var(--t1);}

/* TYPING */
.typing{display:flex;gap:5px;padding:6px 2px;}
.typing span{width:7px;height:7px;border-radius:50%;background:var(--accent);opacity:.4;animation:bounce 1.2s infinite;}
.typing span:nth-child(2){animation-delay:.2s;}
.typing span:nth-child(3){animation-delay:.4s;}
@keyframes bounce{0%,80%,100%{transform:translateY(0);opacity:.4}40%{transform:translateY(-5px);opacity:1}}

/* INPUT */
#input-area{background:var(--surface);border-top:1px solid var(--border);padding:10px 14px 14px;flex-shrink:0;}
.input-box{max-width:720px;margin:0 auto;background:var(--bg);border:1.5px solid var(--border);border-radius:14px;display:flex;align-items:flex-end;gap:8px;padding:10px 11px;transition:border-color .2s,box-shadow .2s;}
.input-box:focus-within{border-color:var(--accent);box-shadow:0 0 0 3px rgba(45,106,79,.1);}
#user-input{flex:1;background:none;border:none;outline:none;font-family:inherit;font-size:16px;color:var(--t1);resize:none;max-height:150px;line-height:1.5;overflow-y:auto;-webkit-appearance:none;}
#user-input::placeholder{color:#b0a99f;}
#send-btn{width:36px;height:36px;border-radius:10px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background .2s;-webkit-tap-highlight-color:transparent;}
#send-btn:not(:disabled){background:var(--accent);}
#send-btn:not(:disabled):active{background:var(--accent-h);}
#send-btn:disabled{background:var(--border);cursor:not-allowed;}
.hint{text-align:center;font-size:11px;color:var(--t3);margin-top:6px;}

/* TOAST */
#toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:#c62828;color:#fff;padding:10px 20px;border-radius:10px;font-size:13px;display:none;z-index:999;box-shadow:0 4px 20px rgba(0,0,0,.2);white-space:nowrap;}

@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* DESKTOP ‚Äî show sidebar always */
@media(min-width:641px){
  #menu-btn{display:none;}
  #overlay{display:none !important;}
}

/* MOBILE */
@media(max-width:640px){
  #sidebar{
    position:fixed;left:0;top:0;height:100%;
    transform:translateX(-100%);
    box-shadow:4px 0 20px rgba(0,0,0,.15);
  }
  #sidebar.open{transform:translateX(0);}
  .sugg-grid{grid-template-columns:1fr;}
  #welcome h1{font-size:22px;}
  #welcome p{font-size:13px;}
  .msg-body{font-size:14px;}
  /* Fix iOS keyboard pushing layout */
  #main{height:100%;height:-webkit-fill-available;}
}
</style>
</head>
<body>

<div id="toast"></div>
<div id="overlay" onclick="closeSidebar()"></div>

<!-- SIDEBAR -->
<aside id="sidebar">
  <div class="logo">Subodh<span>_AI</span></div>
  <button id="new-btn" onclick="newChat()">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
    New chat
  </button>
  <div class="sec-title" id="hist-label" style="display:none">Recent</div>
  <div id="hist-list"></div>
  <div class="sidebar-bottom">
    <div class="user-row">
      <div class="av">S</div>
      <div>
        <div style="font-size:14px;font-weight:500">Subodh</div>
        <div style="font-size:11px;color:var(--t3)">Personal ¬∑ Free</div>
      </div>
    </div>
  </div>
</aside>

<!-- MAIN -->
<main id="main">
  <div id="topbar">
    <button id="menu-btn" onclick="toggleSidebar()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6b6560" stroke-width="2.5"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>
    <div class="model-badge">‚ú¶ Subodh-AI v1.0</div>
    <div class="status-dot" title="Online"></div>
  </div>

  <div id="chat">
    <div id="welcome">
      <div class="w-icon">‚ú¶</div>
      <h1>Hello, I'm Subodh_AI</h1>
      <p>Your personal AI assistant. Ask me anything ‚Äî I'm here to help you think, create, and explore.</p>
      <div class="sugg-grid">
        <div class="sugg-card" onclick="sendSugg('Draft a professional email to my team about a project update')"><strong>‚úçÔ∏è Write for me</strong>Draft a professional email</div>
        <div class="sugg-card" onclick="sendSugg('Give me 5 creative startup ideas in fintech')"><strong>üí° Brainstorm</strong>5 startup ideas in fintech</div>
        <div class="sugg-card" onclick="sendSugg('Explain how async/await works in JavaScript with examples')"><strong>üßë‚Äçüíª Help me code</strong>Explain async/await in JS</div>
        <div class="sugg-card" onclick="sendSugg('What is machine learning explained in simple terms?')"><strong>üìö Explain</strong>What is machine learning?</div>
      </div>
    </div>
  </div>

  <div id="input-area">
    <div class="input-box">
      <textarea id="user-input" placeholder="Message Subodh_AI..." rows="1"
        oninput="resize(this)" onkeydown="handleKey(event)"></textarea>
      <button id="send-btn" disabled onclick="sendMsg()">
        <svg viewBox="0 0 24 24" width="15" height="15" fill="white"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
      </button>
    </div>
    <div class="hint">Subodh_AI can make mistakes. Verify important info.</div>
  </div>
</main>

<script>
let msgs = [], history = [], curId = null, busy = false;
const chatEl = document.getElementById('chat');
const inputEl = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');

inputEl.addEventListener('input', () => {
  sendBtn.disabled = !inputEl.value.trim() || busy;
});

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('overlay').classList.toggle('show');
}

function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('overlay').classList.remove('show');
}

function resize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 150) + 'px';
}

function handleKey(e) {
  // On mobile, don't submit on Enter (let user use send button)
  if (e.key === 'Enter' && !e.shiftKey && window.innerWidth > 640) {
    e.preventDefault();
    sendMsg();
  }
}

function sendSugg(text) {
  inputEl.value = text;
  resize(inputEl);
  sendMsg();
}

async function sendMsg() {
  const text = inputEl.value.trim();
  if (!text || busy) return;

  const w = document.getElementById('welcome');
  if (w) w.remove();

  msgs.push({ role: 'user', content: text });
  appendMsg('user', text);
  inputEl.value = '';
  inputEl.style.height = 'auto';
  sendBtn.disabled = true;
  busy = true;

  // Close sidebar on mobile after sending
  closeSidebar();

  if (!curId) {
    curId = Date.now();
    history.unshift({ id: curId, title: text.slice(0, 38) + (text.length > 38 ? '‚Ä¶' : '') });
    renderHist();
  }

  const typingEl = appendTyping();

  try {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ messages: msgs })
    });
    const data = await res.json();
    typingEl.remove();

    if (data.error) {
      showToast('‚ö†Ô∏è ' + data.error);
      appendMsg('ai', '‚ö†Ô∏è ' + data.error);
    } else {
      msgs.push({ role: 'assistant', content: data.reply });
      appendMsg('ai', data.reply);
    }
  } catch {
    typingEl.remove();
    showToast('‚ö†Ô∏è Could not connect.');
    appendMsg('ai', '‚ö†Ô∏è Could not connect. Please try again.');
  }

  busy = false;
  sendBtn.disabled = !inputEl.value.trim();
}

function appendMsg(role, text) {
  const wrap = document.createElement('div');
  wrap.className = 'msg-wrap';
  wrap.innerHTML = `
    <div class="msg">
      <div class="msg-av ${role}">${role === 'user' ? 'S' : '‚ú¶'}</div>
      <div style="flex:1;min-width:0">
        <div class="msg-name">${role === 'user' ? 'You' : 'Subodh_AI'}</div>
        <div class="msg-body ${role === 'user' ? 'user-body' : ''}">${formatText(text)}</div>
        <div class="msg-actions">
          <button class="act-btn" onclick="copyText(this, ${JSON.stringify(text)})">Copy</button>
          ${role === 'ai' ? '<button class="act-btn" onclick="regen()">‚Ü∫ Retry</button>' : ''}
        </div>
      </div>
    </div>`;
  chatEl.appendChild(wrap);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function appendTyping() {
  const wrap = document.createElement('div');
  wrap.className = 'msg-wrap';
  wrap.innerHTML = `<div class="msg"><div class="msg-av ai">‚ú¶</div><div><div class="msg-name">Subodh_AI</div><div class="typing"><span></span><span></span><span></span></div></div></div>`;
  chatEl.appendChild(wrap);
  chatEl.scrollTop = chatEl.scrollHeight;
  return wrap;
}

function formatText(text) {
  text = text.replace(/```(\w+)?\n?([\s\S]*?)```/g, (_, l, c) =>
    `<pre><code>${escHtml(c.trim())}</code></pre>`);
  text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
  text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  text = text.replace(/\n/g, '<br>');
  return text;
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function copyText(btn, text) {
  navigator.clipboard.writeText(text).then(() => {
    btn.textContent = '‚úì Copied!';
    setTimeout(() => btn.textContent = 'Copy', 2000);
  });
}

async function regen() {
  if (busy || msgs.length < 2) return;
  msgs.pop();
  const all = chatEl.querySelectorAll('.msg-wrap');
  all[all.length - 1].remove();
  busy = true; sendBtn.disabled = true;
  const typingEl = appendTyping();
  try {
    const res = await fetch('/api/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ messages: msgs }) });
    const data = await res.json();
    typingEl.remove();
    const reply = data.reply || '‚ö†Ô∏è ' + (data.error || 'Error');
    msgs.push({ role: 'assistant', content: reply });
    appendMsg('ai', reply);
  } catch { typingEl.remove(); appendMsg('ai', '‚ö†Ô∏è Retry failed.'); }
  busy = false; sendBtn.disabled = !inputEl.value.trim();
}

function newChat() {
  msgs = []; curId = null;
  chatEl.innerHTML = '';
  const w = document.createElement('div');
  w.id = 'welcome';
  w.innerHTML = `
    <div class="w-icon">‚ú¶</div>
    <h1>Hello, I'm Subodh_AI</h1>
    <p>Your personal AI assistant. Ask me anything.</p>
    <div class="sugg-grid">
      <div class="sugg-card" onclick="sendSugg('Draft a professional email to my team about a project update')"><strong>‚úçÔ∏è Write for me</strong>Draft a professional email</div>
      <div class="sugg-card" onclick="sendSugg('Give me 5 creative startup ideas in fintech')"><strong>üí° Brainstorm</strong>5 startup ideas in fintech</div>
      <div class="sugg-card" onclick="sendSugg('Explain how async/await works in JavaScript with examples')"><strong>üßë‚Äçüíª Help me code</strong>Explain async/await in JS</div>
      <div class="sugg-card" onclick="sendSugg('What is machine learning explained in simple terms?')"><strong>üìö Explain</strong>What is machine learning?</div>
    </div>`;
  chatEl.appendChild(w);
  renderHist();
  closeSidebar();
}

function renderHist() {
  const list = document.getElementById('hist-list');
  const label = document.getElementById('hist-label');
  label.style.display = history.length ? '' : 'none';
  list.innerHTML = history.map(h =>
    `<div class="hist-item${h.id === curId ? ' active' : ''}" onclick="closeSidebar()" title="${h.title}">${h.title}</div>`
  ).join('');
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.display = 'block';
  setTimeout(() => t.style.display = 'none', 3000);
}
</script>
</body>
</html>
